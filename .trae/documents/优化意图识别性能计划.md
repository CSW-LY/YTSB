# 优化意图识别性能计划

## 问题分析

**第一次意图识别测试慢的原因：**

1. **模型加载时机**：
   - 模型在第一次请求时才加载，而不是服务启动时
   - BGE-M3 模型较大，加载时间长（20-30秒）

2. **嵌入构建时机**：
   - 语义规则的嵌入在第一次请求时才构建
   - 批量编码所有语义规则需要时间

3. **初始化流程**：
   - `SemanticRecognizer.initialize()` 是异步方法
   - 服务启动时没有预初始化识别器

4. **缓存机制**：
   - 语义嵌入缓存（`_intent_embeddings`）只在首次使用时填充

## 优化目标

1. **服务启动时预加载模型**：
   - 模型在服务启动时加载，而非首次请求时

2. **服务启动时预构建嵌入**：
   - 语义规则嵌入在服务启动时构建

3. **减少首次请求延迟**：
   - 首次请求响应时间从 20-30 秒降至 < 1 秒

4. **保持后续请求性能**：
   - 后续请求继续使用缓存，保持高性能

## 优化方案

### 方案 1：服务启动时预初始化（推荐）
**优点**：
- 彻底解决首次请求慢的问题
- 用户体验最佳
- 不影响现有功能

**缺点**：
- 服务启动时间会增加
- 需要修改初始化流程

### 方案 2：后台异步预加载
**优点**：
- 服务启动速度快
- 首次请求仍可能较慢

**缺点**：
- 不能完全保证首次请求时模型已加载

### 方案 3：缓存嵌入到文件
**优点**：
- 可以减少模型加载时间

**缺点**：
- 实现复杂
- 嵌入缓存需要定期更新

## 具体实现计划

### 任务 1：修改服务启动流程，预加载模型
- **优先级**：P0
- **描述**：
  - 修改 `get_recognizer_chain()` 和 `get_recognizer_chain_for_app()` 函数
  - 服务启动时预初始化所有识别器
  - 确保模型在服务启动时加载

### 任务 2：修改 SemanticRecognizer，预构建嵌入
- **优先级**：P0
- **描述**：
  - 在服务启动时加载所有语义规则
  - 批量构建所有语义规则的嵌入
  - 填充 `_intent_embeddings` 缓存

### 任务 3：优化模型加载逻辑
- **优先级**：P1
- **描述**：
  - 确保正确使用本地模型路径
  - 避免重复加载模型
  - 添加模型加载状态检查

### 任务 4：添加性能监控
- **优先级**：P2
- **描述**：
  - 添加模型加载时间监控
  - 添加嵌入构建时间监控
  - 添加首次请求响应时间监控

## 详细实现步骤

### 任务 1：修改服务启动流程
**文件**：`app/core/__init__.py`

**修改内容**：
1. 在 `get_recognizer_chain()` 中添加缓存机制
2. 服务启动时预初始化识别器
3. 确保 `SemanticRecognizer.initialize()` 在服务启动时调用

**测试要求**：
- 服务启动时模型加载日志
- 首次请求响应时间 < 1 秒
- 后续请求响应时间 < 0.1 秒

### 任务 2：修改 SemanticRecognizer
**文件**：`app/services/recognizer/semantic.py`

**修改内容**：
1. 添加应用级别的嵌入缓存
2. 在服务启动时预加载语义规则
3. 批量构建所有语义规则的嵌入

**测试要求**：
- 服务启动时嵌入构建日志
- 语义规则嵌入缓存正确填充
- 首次请求时直接使用缓存

### 任务 3：优化模型加载逻辑
**文件**：`app/ml/embedding.py`

**修改内容**：
1. 确保本地模型路径正确使用
2. 添加模型加载状态检查
3. 避免重复加载模型

**测试要求**：
- 本地模型路径正确使用
- 模型只加载一次
- 模型加载失败时有合理的错误处理

### 任务 4：添加性能监控
**文件**：`app/core/__init__.py`, `app/services/recognizer/semantic.py`

**修改内容**：
1. 添加模型加载时间日志
2. 添加嵌入构建时间日志
3. 添加首次请求响应时间日志

**测试要求**：
- 模型加载时间日志
- 嵌入构建时间日志
- 首次请求响应时间日志

## 预期效果

### 优化前
- **服务启动时间**：快速（无模型加载）
- **首次请求响应时间**：20-30 秒（模型加载 + 嵌入构建）
- **后续请求响应时间**：< 0.1 秒（使用缓存）

### 优化后
- **服务启动时间**：30-40 秒（包含模型加载 + 嵌入构建）
- **首次请求响应时间**：< 1 秒（直接使用缓存）
- **后续请求响应时间**：< 0.1 秒（使用缓存）

## 风险评估

**潜在风险**：
1. **服务启动时间增加**：
   - 风险：服务启动时间从几秒增加到 30-40 秒
   - 缓解：这是一次性成本，用户体验收益大于启动时间损失

2. **内存使用增加**：
   - 风险：模型和嵌入缓存会占用更多内存
   - 缓解：BGE-M3 模型在 CPU 上的内存占用是可接受的

3. **初始化失败**：
   - 风险：模型加载失败会导致服务启动失败
   - 缓解：添加合理的错误处理和 fallback 机制

## 验证计划

1. **服务启动验证**：
   - 检查服务启动日志，确认模型加载和嵌入构建
   - 验证启动时间（30-40 秒）

2. **性能验证**：
   - 测试首次请求响应时间（< 1 秒）
   - 测试后续请求响应时间（< 0.1 秒）
   - 测试不同输入文本的响应时间

3. **功能验证**：
   - 验证意图识别功能正常
   - 验证语义匹配正常
   - 验证缓存机制正常

4. **稳定性验证**：
   - 重启服务多次，验证每次启动都正常
   - 测试并发请求，验证性能稳定
