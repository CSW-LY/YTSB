# 意图识别找不到的原因分析

## 问题

输入"我要检索零件"提示没找到。

## 可能原因

### 1. 应用配置缺失

**症状**：`App configuration not found: plm_assistant`

**原因**：
- 数据库中没有 `plm_assistant` 应用的配置记录
- 应用配置的 `intent_ids` 为空或引用了不存在的分类

**解决方案**：
1. 通过 Web UI 创建应用配置
2. 通过 Admin API 创建应用配置
3. 直接插入数据库记录

### 2. 语义识别器缓存问题

**症状**：日志中没有嵌入构建信息

**原因分析**：
- 语义识别器使用 `_intent_embeddings` 字典缓存
- `_build_intent_embeddings()` 只在启动时调用一次
- 如果启动时调用失败，或者识别器链共享导致缓存未初始化，会导致无法匹配

**相关代码**（`app/services/recognizer/semantic.py:82-83`）：
```python
if not self._intent_embeddings:
    await self._build_intent_embeddings(categories, rules)
```

**可能问题**：
1. **识别器链共享问题**：
   - `main_ui.py` 和 `intent.py` 共享同一个识别器链
   - 启动时在 `main_ui.py` 中预热
   - 但预热时传入的 `categories` 和 `rules` 可能不完整
   - 导致 `_intent_embeddings` 构建不正确

2. **预热时机问题**：
   - 预热时调用 `get_app_intent_context()`
   - 但此时应用配置可能不存在（`plm_assistant` 未创建）
   - 导致查询失败，`categories` 和 `rules` 为空

### 3. ConfigService 缓存问题

**症状**：首次请求能找到，后续请求找不到

**原因**：
- `ConfigService` 使用 `context_cache` 缓存
- 缓存键是 `f"context:{app_key}"`
- 如果缓存逻辑有问题，可能导致错误缓存

**相关代码**（`app/services/config_service.py:132-136`）：
```python
context_key = f"context:{app_key}"
cached = await self.context_cache.get(context_key)

if cached is not None:  # 注意：这里应该是 cached is None
    ...
```

**问题**：`if cached is not None` 应该改为 `if cached is None`

## 推荐解决方案

### 方案 1：修复 ConfigService 缓存逻辑（优先）

**问题**：`config_service.py:133` 的条件判断错误

**修改**：
```python
# 之前
if cached is not None:  # 错误：如果缓存存在则不查询

# 修改为
if cached is None:  # 正确：如果缓存不存在则查询
```

### 方案 2：确保预热时使用正确的应用配置

**问题**：预热时使用 `app_key="plm_assistant"` 查询配置，但配置不存在

**修改**：预热时跳过应用配置，直接查询所有活跃规则
```python
# main_ui.py:54-78
# 修改为：不依赖应用配置
async with async_session_maker() as session:
    # 直接查询所有活跃分类和规则
    categories = await session.execute(
        select(IntentCategory).where(IntentCategory.is_active == True)
    )
    categories = categories.scalars().all()

    rules = await session.execute(
        select(IntentRule).where(IntentRule.is_active == True)
    )
    rules = rules.scalars().all()

    # 构建嵌入
    for r in recognizer.recognizers:
        if r.recognizer_type == "semantic":
            await r._build_intent_embeddings(categories, rules)
            break
```

### 方案 3：添加调试日志

**目的**：追踪识别流程

**修改**：在关键位置添加日志
```python
# semantic.py:83
if not self._intent_embeddings:
    logger.info(f"Building embeddings for {len(categories)} categories and {len(rules)} rules")
    await self._build_intent_embeddings(categories, rules)
    logger.info(f"Built embeddings for {len(self._intent_embeddings)} intents")
```

## 验证步骤

1. 检查数据库中是否存在 `plm_assistant` 应用配置
2. 检查日志中是否有 "Building embeddings" 信息
3. 检查日志中是否有 "Built embeddings for X intents" 信息
4. 检查识别时是否有 "No active categories found" 警告
